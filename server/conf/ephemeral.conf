samantha.ephemeral {
  engineType = "RECOMMENDER"

  entityDaosConfig {
    entityDaoKey = "entityDaoName"
    RequestEntityDAO {
      daoConfigClass = "org.grouplens.samantha.server.dao.RequestEntityDAOConfig"
      entitiesKey = "entities"
    }
    RequestItemIDListDAO {
      daoConfigClass = "org.grouplens.samantha.server.dao.RequestItemIDListDAOConfig"
      attrName = "movieId"
      itemListKey = "movieIds"
    }
    CSVFileEntityDAO {
      daoConfigClass = "org.grouplens.samantha.server.dao.CSVFileDAOConfig"
      filePathKey = "filePath"
      separatorKey = "separator"
    }
  }

  indexers = [
    {
      name = "StandardOutputIndexer"
      configClass = "org.grouplens.samantha.server.indexer.LoggerBasedIndexerConfig"
    }
  ]

  retrievers = [
    {
      // TODO: Should we exclude movies that the user has rated? If so, do we do that here?
      name = "FeatureSupportMovieRetriever"
      configClass = "org.grouplens.samantha.server.retriever.FeatureSupportRetrieverConfig"
      maxHits = 5000
      itemAttrs = ["movieId"]
      supportAttr = "support"
      predictorName = "svd-rating-predictor"
      modelName = "svd-rating-model"
    },
    {
      name = "RequestBasedMovieRetriever"
      configClass = "org.grouplens.samantha.server.retriever.RequestBasedRetrieverConfig"
      entityDaosConfig = ${samantha.ephemeral.entityDaosConfig}
      daoConfigKey = "daoConfig"
    }
  ]

  predictors = [{
    name = "svd-rating-predictor"
    configClass = "org.grouplens.samantha.server.predictor.SVDFeaturePredictorConfig"
    modelName = "svd-rating-model"
    modelFile = ${samantha.modelDir}"/svd-rating-model.bin"
    labelName = "rating"
    weightName = "weight"
    entityDaosConfig = ${samantha.ephemeral.entityDaosConfig}
    daoConfigKey = "daoConfig"
    serializedKey = "serialized"
    instanceName = "instance"
    evaluatorNames = []
    groupKeys = ["userId"]
    featurizer {
      featureExtractorList = [
        {
          extractorConfigClass = "org.grouplens.samantha.server.featurizer.ConstantOneExtractorConfig"
          indexName = "BIASES"
          attrName = "globalBias"
          feaName = "globalBias"
        }, {
          extractorConfigClass = "org.grouplens.samantha.server.featurizer.StringValueExtractorConfig"
          indexName = "BIASES"
          attrName = "userId"
          feaName = "userBias"
        }, {
//          extractorConfigClass = "org.grouplens.samantha.server.featurizer.StringValueExtractorConfig"
//          attrName = "movieId"
//          indexName = "BIASES"
//          feaName = "movieBias"
//        }, {
          extractorConfigClass = "org.grouplens.samantha.server.featurizer.StringValueExtractorConfig"
          indexName = "FACTORS"
          attrName = "userId"
          feaName = "userFactor"
        }, {
          extractorConfigClass = "org.grouplens.samantha.server.featurizer.StringValueExtractorConfig"
          attrName = "movieId"
          indexName = "FACTORS"
          feaName = "movieFactor"
        }
      ]
    }
    objectiveConfig {
      objectiveClass = "org.grouplens.samantha.server.objective.L2NormLossConfig"
    }
    onlineOptimizationMethod {
      methodClass = "org.grouplens.samantha.server.solver.StochasticGradientDescentConfig"
      maxIter = 1
      learningRate = 0.001
      l2coef = 0.01
    }
    optimizationMethod {
      methodClass = "org.grouplens.samantha.server.solver.AsyncParallelSGDConfig"
      maxIter = 20
      learningRate = 0.01
      l2coef = 0.005
      cachePath = ${samantha.dataDir}"/cachePath"
    }
    factDim = 30
    biasFeas = ["globalBias", "userBias"] //, "movieBias"]
    ufactFeas = ["userFactor"]
    ifactFeas = ["movieFactor"]
  }]

  rankers = [{
    name = "EphemeralRanker"
    configClass = "org.grouplens.samantha.ephemeral.EphemeralRankerConfig"
    svdfeaturePredictor = "svd-rating-predictor"
    svdfeatureModel = "svd-rating-model"

    selectionCriteriaByRound = {
      "1" = [
        {
          limit: 100
          n: 5
          ratedDropout: 0.5
          dropout: 0.5
        },
        {
          limit: 200
          n: 5
          ratedDropout: 0.5
          dropout: 0.5
        }]
      "2" = [
        {
          limit: 10
          n: 3
          ratedDropout: 1.0
          dropout: 0.5
        },
        {
          limit: 50
          n: 2
          ratedDropout: 0.5
          dropout: 0.5
        },
        {
          limit: 150
          n: 5
          ratedDropout: 0.5
          dropout: 0.5
        }]
      // special key for default case
      "default" = [
        {
          limit: 5
          n: 5
          ratedDropout: 1.0
          dropout: 0.50
        },
        {
          limit: 100
          n: 5
          ratedDropout: 0.5
          dropout: 0.5
        }]
    }

    preferences = [-1, 0, 1]

    // These are relative values.
    preferenceWeights = {
      "1" = 1.0
      "0" = 0.0
      "-1" = -0.5
    }

    // -1 indicates that we should exclude movies with that preference score
    // going back all of the rounds. 0 excludes no movies with that preference
    // score. Positive integers exclude movies in the last n rounds...
    numRoundsToExclude = {
      "1" = -1
      "0" = -1
      "-1" = -1
    }
  }]

  recommenders = [{
    name = "ephemeral-recommender"
    configClass = "org.grouplens.samantha.server.recommender.StandardRecommenderConfig"
    retriever = "RequestBasedMovieRetriever"
    ranker = "EphemeralRanker"
  }]

  router {
    configClass = "org.grouplens.samantha.server.router.BasicRouterConfig"
    recommenderKey = "recommender"
    predictorKey = "predictor"
  }

  evaluators = [
    {
      name = "PredictionEvaluator"
      configClass = "org.grouplens.samantha.server.evaluator.PredictionEvaluatorConfig"
      predictionIndexers = []
      indexers = ["StandardOutputIndexer"]
      indexerType = "PredictionEvaluator"
      predictorKey = "predictor"
      groupKey = "userId"
      entityDaosConfig = ${samantha.ephemeral.entityDaosConfig}
      daoConfigKey = "evaluatorDaoConfig"
      metrics = [
        {
          metricConfigClass = "org.grouplens.samantha.server.evaluator.metric.MAEConfig"
          labelName = "rating"
        }, {
          metricConfigClass = "org.grouplens.samantha.server.evaluator.metric.RMSEConfig"
          labelName = "rating"
        }
      ]
    }
  ]

  schedulers = []
}
